---
version: 3

images:
  base_image:
    name: registry.access.redhat.com/ubi10/python-312-minimal:latest

dependencies:
  # Install ansible-core first, before galaxy collections
  ansible_core:
    package_pip: ansible-core>=2.17.0
  # Install ansible-runner (required for execution environments)
  ansible_runner:
    package_pip: ansible-runner>=2.3.0
  # Python dependencies
  python: requirements.txt
  # System packages
  system: bindep.txt
  # Galaxy collections (installed after ansible-core)
  galaxy: requirements.yml

additional_build_steps:
  prepend_base:
    # Install essential packages (Python 3.11 already included in base image)
    - RUN dnf update -y && dnf install -y git openssh-clients && dnf clean all
  prepend_galaxy:
    # Verify ansible-core and ansible-runner installation before galaxy operations
    - RUN ansible --version
    - RUN ansible-galaxy --version
    - RUN ansible-runner --version
  append_final:
    # Copy ansible configuration
    - COPY ansible.cfg /etc/ansible/ansible.cfg
    # Verify ansible configuration
    - RUN cat /etc/ansible/ansible.cfg
